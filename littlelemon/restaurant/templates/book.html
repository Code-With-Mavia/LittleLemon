{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="booking-page">
  <article>
    <h1>Make a reservation</h1>
    <div class="row">
      <!-- Booking Form -->
      <div class="column booking-form">
        <form id="booking-form">
          {% csrf_token %}
          {{ form.as_p }}
          <input type="submit" id="booking-button" value="Book Now">
          <p id="booking-message" style="text-align:center; font-weight:bold; margin-top:1rem;"></p>
        </form>
      </div>

      <!-- Map -->
      <div class="column">
        <div class="videowrap">
          <iframe
            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d11898.289517452584!2d-87.60853049433447!3d41.79442860243028!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x880e2912ce6f7027%3A0xc0cfb5545d4a37b2!2sHyde%20Park%2C%20Chicago%2C%20IL%2C%20USA!5e0!3m2!1sen!2spt!4v1662384760663!5m2!1sen!2spt"
            width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>
    </div>
  </article>
</section>

<script>
  const reservationDateInput = document.getElementById("id_reservation_date");
  reservationDateInput.type = "date";

  // Preselect current date
  const today = new Date().toISOString().split('T')[0];
  reservationDateInput.value = today;

  const bookingMessage = document.getElementById("booking-message");

  async function getBookings(date) {
    const response = await fetch(`/bookings/?date=${date}`);
    const data = await response.json();

    const reservedSlots = data.map(item => item.fields.reservation_slot);

    let slotOptions = '<option value="" disabled>Select time</option>';
    for (let i = 10; i < 20; i++) {
      const label = `${i}:00`;
      slotOptions += reservedSlots.includes(i)
        ? `<option value="${i}" disabled>${label} (Booked)</option>`
        : `<option value="${i}">${label}</option>`;
    }

    const timeSelect = document.getElementById("id_reservation_slot");
    if (timeSelect) timeSelect.innerHTML = slotOptions;

    // Show message if no bookings exist
    bookingMessage.innerText = reservedSlots.length === 0 ? "No bookings for this date" : "";
  }

  reservationDateInput.addEventListener("change", () => {
    getBookings(reservationDateInput.value);
  });

  const bookingForm = document.getElementById("booking-form");
  bookingForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const formData = {
      first_name: document.getElementById("id_first_name").value,
      last_name: document.getElementById("id_last_name").value,
      guest_number: parseInt(document.getElementById("id_guest_number").value),
      comment: document.getElementById("id_comment").value,
      reservation_date: reservationDateInput.value,
      reservation_slot: parseInt(document.getElementById("id_reservation_slot").value)
    };

    const res = await fetch("/bookings/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken
      },
      body: JSON.stringify(formData)
    });

    const result = await res.json();
    if (result.error) {
      bookingMessage.innerText = "This slot is already booked.";
      bookingMessage.style.color = "red";
    } else {
      bookingMessage.innerText = "Reservation successful!";
      bookingMessage.style.color = "green";
      getBookings(formData.reservation_date);
      bookingForm.reset();
      reservationDateInput.value = today;
    }
  });

  // Initialize slots for today
  getBookings(today);
</script>
{% endblock %}
